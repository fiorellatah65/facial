{% extends "base.html" %}

{% block title %}Iniciar SesiÃ³n{% endblock %}

{% block content %}
<h2>ğŸ”‘ Iniciar SesiÃ³n</h2>

<form method="POST">
    <div class="form-group">
        <label>ğŸ‘¤ Usuario *</label>
        <input type="text" name="usuario" id="usuario-login" required 
               placeholder="Tu nombre de usuario">
    </div>

    <div class="form-group">
        <label>ğŸ”’ ContraseÃ±a *</label>
        <input type="password" name="contra" required 
               placeholder="Tu contraseÃ±a">
    </div>

    <button type="submit" class="btn btn-primary">
        âœ… Iniciar SesiÃ³n
    </button>
</form>

<div class="divider">
    <span>O usa reconocimiento facial</span>
</div>

<div class="form-group">
    <label>ğŸ‘¤ Usuario (para login facial) *</label>
    <input type="text" id="usuario-facial" 
           placeholder="Ingresa tu usuario primero">
</div>

<button class="btn btn-facial" onclick="iniciarLoginFacial()">
    ğŸ“¸ Login con Rostro
</button>

<div id="video-container">
    <video id="video" autoplay playsinline></video>
    <div class="video-controls">
        <button type="button" class="btn btn-primary" onclick="capturarLogin()">
            âœ… Verificar Rostro
        </button>
        <button type="button" class="btn btn-secondary" onclick="cancelarCaptura()">
            âŒ Cancelar
        </button>
    </div>
</div>

<div class="text-center" style="margin-top: 1.5rem;">
    <a href="{{ url_for('registro') }}" class="link">
        Â¿No tienes cuenta? RegÃ­strate aquÃ­
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
let stream = null;
const video = document.getElementById('video');

async function iniciarLoginFacial() {
    const usuario = document.getElementById('usuario-facial').value.trim();
    if (!usuario) {
        alert('âš ï¸ Por favor ingresa tu nombre de usuario primero');
        document.getElementById('usuario-facial').focus();
        return;
    }

    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 }, 
                height: { ideal: 480 },
                facingMode: 'user'
            } 
        });
        video.srcObject = stream;
        document.getElementById('video-container').style.display = 'block';
    } catch (error) {
        alert('âŒ Error al acceder a la cÃ¡mara: ' + error.message);
        console.error(error);
    }
}

function capturarLogin() {
    const usuario = document.getElementById('usuario-facial').value.trim();
    
    if (!video.videoWidth || !video.videoHeight) {
        alert('âš ï¸ Espera a que la cÃ¡mara se active completamente');
        return;
    }

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    const imagenBase64 = canvas.toDataURL('image/jpeg', 0.8);
    
    fetch('/login_facial', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            imagen: imagenBase64,
            usuario: usuario
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ' + data.mensaje);
            window.location.href = '/bienvenida';
        } else {
            alert('âŒ ' + data.error);
        }
        cancelarCaptura();
    })
    .catch(error => {
        alert('âŒ Error de conexiÃ³n: ' + error);
        cancelarCaptura();
    });
}

function cancelarCaptura() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    document.getElementById('video-container').style.display = 'none';
}
</script>
{% endblock %}